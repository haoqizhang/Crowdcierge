<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-GB">
    
    <head>
        <title>Mobi: admin page of our people planning for you</title>
        <meta http-equiv="Content-Type"
        content="application/xhtml+xml; charset=utf-8" />
        <link rel="stylesheet" type="text/css" media="all" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/themes/smoothness/jquery-ui.css"
        />
        <link rel='stylesheet' type='text/css' href='fullcalendar/fullcalendar.css' />
        <link rel='stylesheet' type='text/css' href='fullcalendar/fullcalendar.print.css' media='print' />
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.min.js"></script>
        <script type="text/javascript" src="humane.js"></script>
        <script type="text/javascript" src="mobi-admin-crowd.js"></script>
        <script type="text/javascript" src="https://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.3"></script>      
        <script type='text/javascript' src='fullcalendar/fullcalendar.js'></script>
        <script type="text/javascript" src="jquery/jquery.validate.min.js"></script>
        <script type="text/javascript">
        
            ///////////////////////////////////////////
            // CALENDAR CODE
            ///////////////////////////////////////////
        
            // Set time shift
            var shift;
            
            // Maintain total duration for scheduling checks
            var totalDuration;
            
            // Get today's date
            var date = new Date();
            var d = date.getDate();
            var m = date.getMonth();
            var y = date.getFullYear();
            
            // Time used for drop checks. Should be begin time unless mid-trip
            var calBegin;
			var calEnd;
            
            // Event data. Do NOT change reference
            var eventSource = [];
                
            // Local check item list
            var checkItems = {};
            
			var slotMinutes = 15;
			
			var refresh =self.setInterval(function(){refreshCalendar()},100);
			
            // Called from document ready to initialize the calendar
            // TODO get the actual date of the trip here
            function initializeCalendar() {
                // Calculate time shifting
                var shift; 
                if (endTime > 1440) {
                    shift = (endTime-1440)/60;
                } else {
                    shift = 0;
                }
                
				beginTime = beginTime - slotMinutes;
				//endTime = endTime + slotMinutes;
				
                // Find start and end times pre-shift
                var start = beginTime/60 - shift;
                var end = endTime/60 - shift;
                
                // Initialize calendar with correct times
                initCalendar(shift, start, end);
                
                // Add check items stored in state
                //checkItems = state.checkItems;
                if (!checkItems || checkItems.length == 0) {
                    //checkItems = {};
                }

                for (var key in checkItems) {
                    //createCheckItem("#checkStreamBody", checkItems[key]);
                }
            }
            
            // Initialize the calendar
            function initCalendar(timeShift, start, end) {
                // Make calendar with specified options
                shift = timeShift;
                var cal = $("#calendar");
                cal.fullCalendar({
                    height: 1000000,
                    editable: true,
                    allDayDefault:false,
                    events: [],
                    minTime: start,
                    maxTime: end,
                    allDaySlot: false,
                    slotMinutes: slotMinutes,
                    eventDrop: syncEventDrop,
                    eventResize: syncEventDrag,
                    eventClick: function(calEvent, jsEvent, view) {
                        eventClick(calEvent, jsEvent, view);
                    },
					eventColor: "white",
					eventBorderColor: "gray",
					eventTextColor: "#000000"
                });
                
                // Add event sources
                cal.fullCalendar( 'addEventSource', eventSource);
				cal.fullCalendar( 'addEventSource', travelTimeEventSource);
                
                // Set to day view and remove header
                cal.fullCalendar( 'changeView', 'agendaDay');
                $(".fc-header").hide();
                
                // Shift table times
				var slotNum = (endTime - beginTime)/slotMinutes;
                for (var s = 0; s < slotNum; s+=1) {
                    var oldTimes = $(".fc-slot" + s).html();
                    var newTimes = oldTimes;
                    if (newTimes) {
                        for (var i = 1; i < 13; i++) {
                            var up = i+shift;
                            up = up%12;
                            if  (i > up && i != 12) {
                                if (up == 0) {
                                    up = 12;
                                }
                                newTimes = newTimes.replace(">" + i + "pm", ">" + up + "AM");
                                newTimes = newTimes.replace(">" + i + "am", ">" + up + "PM");
                            } else {
                                if (up == 0) {
                                    up = 12;
                                }
                                newTimes = newTimes.replace(">" + i + "pm", ">" + up + "PM");
                                newTimes = newTimes.replace(">" + i + "am", ">" + up + "AM");
                            }
                        }        
                        newTimes = newTimes.replace("AM", "am");
                        newTimes = newTimes.replace("PM", "pm");                      
                        $(".fc-slot" + s).html(newTimes);
                    }
                }
				
				// Set table colors
                for (var i = 0; i < slotNum; i++) {
                    $(".fc-slot"+i+" .fc-widget-content").css("background-color", "#d3f1f2");
                }
				
				// Set start and end banners
				$(".fc-slot0 .fc-widget-content").css("background-color", "green");
				$(".fc-slot0").css("background-color", "green");
                $(".fc-slot0 .fc-widget-content").css("text-align", "center");
                $(".fc-slot0 .fc-widget-content div").text("Start");
				
				//$(".fc-slot"+(slotNum-1)+" .fc-widget-content").css("background-color", "red");
                //$(".fc-slot"+(slotNum-1)+" .fc-widget-content").css("text-align", "center");
                //$(".fc-slot"+(slotNum-1)+" .fc-widget-content div").text("End");
				
                // Make event times fix all the time!
                //cal.mousemove(function() {
                //    refreshCalendar()
                //});
                
                // Add items from the itinerary array
                fetchEvents();
                
                // Fix event times
                shiftEventTimes();
                
                if (inProgress) {
                    setCalendarInProgress();
                }
				colorHeaders();
				updateCalendarPins();
            }
            
			function refreshCalendar() {
				shiftEventTimes();
				colorHeaders();
				updateCalendarPins();
			}
			
            // Modify calendar to show trip progress
            function setCalendarInProgress() {
                var slotNum = Math.round((interTime - beginTime - slotMinutes)/slotMinutes);
                for (var i = 0; i < slotNum; i++) {
                    $(".fc-slot"+i+" .fc-widget-content").css("background-color", "#BBBBBB");
                }
				
				var oldSlot = $(".fc-slot"+slotNum+" .fc-widget-content div");
				oldSlot.css("background-color", "white");
				oldSlot.css("position", "absolute");
				
				var newSlot = oldSlot.clone();
				newSlot.css("z-index", 1000);
				newSlot.css("position", "absolute");
				newSlot.css("text-align", "center");
				newSlot.css("background-color", "rgba(255, 165, 0, 0.6)");
				newSlot.css("width", "85%");
				newSlot.text("Current Time:  " + minToTime(calBegin));
				newSlot.appendTo(".fc-slot"+slotNum+" .fc-widget-content");
				
                //$(".fc-slot"+slotNum+" .fc-widget-content").css("background-color", "rgba(255, 165, 0, 0.6)");
                //$(".fc-slot"+slotNum+" .fc-widget-content").css("z-index", 1000);
                //$(".fc-slot"+slotNum+" .fc-widget-content").css("position", "relative");
                //$(".fc-slot"+slotNum+" .fc-widget-content").css("text-align", "center");
                //$(".fc-slot"+slotNum+" .fc-widget-content").text("Current Time");
            }
            
            // Load events on start
            function fetchEvents() {
                for (var i = 0; i < itinerary.length; i++) {
                    addNewItemFromId(itinerary[i]);
                }
                
                // Check for overlap
                detectOverlap();
            }
            
            // Adds a new item to the calendar based on itinerary id
            function addNewItemFromId(itineraryId, addNew) {
                var event = {};
                var item = getItem(itineraryId);
				var saveNew = addNew;

                // Get event start and end times
                event.title = item.data.name;
                if (!item.data.start) {
                    event.start = new Date(y, m, d, calBegin/60 - shift, 0);
                    item.data.start = event.start.getHours()*60 + event.start.getMinutes() + shift*60;
					saveNew = true;
                } else {
                    event.start = new Date(y, m, d, Math.floor(item.data.start/60) - shift, item.data.start%60);
                }
                var endTime = item.data.start + parseInt(item.data.duration);
                var hours = Math.floor(endTime/60);
                event.end = new Date(y, m, d, hours - shift, endTime % 60);
                
                // Change color of traveler decided to keep this activity
                if (keepAct && include(keepAct, itineraryId)) {
                    event.backgroundColor="grey";
                }
                
                if (item.data.start < interTime) {
                    event.backgroundColor="grey";
                    finishedAct.push(itineraryId);
                }
                
                // Push event out and do usual calendar cleanup
                event.itId = itineraryId;
                eventSource.push(event);
                $("#calendar").fullCalendar('refetchEvents');
                detectOverlap();
                shiftEventTimes();
				
				if (saveNew) {
                    saveItemEdit(item);
				}
            }
            
			function updateItineraryOnCalendar() {
				// Sort event source list based on client events
                eventSource.length = 0;
                var newEvents = $("#calendar").fullCalendar( 'clientEvents' );
                for (var i  = 0; i < newEvents.length; i++) {
                    eventSource.push(newEvents[i]);
                }
                eventSource.sort(function(a,b) {
                    return (a.start.getHours() + a.start.getMinutes()/60) - (b.start.getHours() + b.start.getMinutes()/60);
                });
                
                // Update itinerary order and save route if necessary
                var newItinerary = [];
                for (var i = 0; i < eventSource.length; i++) {
                    newItinerary.push(eventSource[i].itId);
                }

                // Save new itinerary order
                itinerary = newItinerary;
                saveItinerary();
                refreshCalendar();
			}
			
            // Removes an item from the calendar based on itinerary id
            function removeItemFromId(itineraryId) {
                for (var i = 0; i < eventSource.length; i++) {
                    if (eventSource[i].itId == itineraryId) {
                        eventSource.splice(i, 1);
                    }
                }
                $("#calendar").fullCalendar('refetchEvents');
            }
            
            // Update the calendar based on an edit made in a dialog
            function updateEditCalendar(oldId, newId) {
                removeItemFromId(oldId);
                addNewItemFromId(newId);
            }
            
            // Update the event source with the events in the calendar and updates route order
            // Called on event drops
            function syncEventDrop(event, dayDelta, minuteDelta, allDay, revertFunc, jsEvent, ui, view) {
				if(!enableEditting){
					revertFunc();
					alert("You must accept the HIT before you can save any edits.");
					return;
				}
			
                // Prevent dragging past start time
                var si = getItem(event.itId);
                var newStart = si.data.start + minuteDelta;
                var newEnd = newStart + parseInt(si.data.duration);
                if (keepAct && finishedAct && (newStart < calBegin || include(keepAct, event.itId) || include(finishedAct, event.itId) || newEnd > calEnd)) {
                    revertFunc();
                    return;
                }
				clearTravelTimes();
            
                // Sort event source list based on client events
                eventSource.length = 0;
                var newEvents = $("#calendar").fullCalendar( 'clientEvents' );
                for (var i  = 0; i < newEvents.length; i++) {
                    eventSource.push(newEvents[i]);
                }
                eventSource.sort(function(a,b) {
                    return (a.start.getHours() + a.start.getMinutes()/60) - (b.start.getHours() + b.start.getMinutes()/60);
                });
                
                // Update itinerary order and save route if necessary
                var newItinerary = [];
                for (var i = 0; i < eventSource.length; i++) {
                    newItinerary.push(eventSource[i].itId);
                }

                // Save new itinerary order
                itinerary = newItinerary;
                saveItinerary();
                
                // Save start of activity
                si.data.start = newStart;
                saveItemEdit(si);
                detectOverlap();
                shiftEventTimes();
            }
            
            // Update activity durations
            // Called on even drag
            function syncEventDrag(event, dayDelta, minuteDelta, revertFunc) {
				if(!enableEditting){
					revertFunc();
					alert("You must accept the HIT before you can save any edits.");
					return;
				}
			
                var si = getItem(event.itId);
                var newEnd = si.data.start + parseInt(si.data.duration) + minuteDelta;
                if (include(keepAct, event.itId) || include(finishedAct, event.itId) || newEnd > calEnd) {
                    revertFunc();
                    return;
                }
				clearTravelTimes();
            
                eventSource.length = 0;
                var newEvents = $("#calendar").fullCalendar( 'clientEvents' );
                for (var i  = 0; i < newEvents.length; i++) {
                    eventSource.push(newEvents[i]);
                }
                eventSource.sort(function(a,b) {
                    return (a.start.getHours() + a.start.getMinutes()/60) - (b.start.getHours() + b.start.getMinutes()/60);
                });
                
                var si = getItem(event.itId);
                si.data.duration = parseInt(si.data.duration) + minuteDelta + "";
                saveItemEdit(si);
                detectOverlap();
                shiftEventTimes();
            }
            
            // Check if there is any overlap in our current event set
            function detectOverlap() {
                // Reload timeblocks for overlap check
                var timeBlocks = [];
                totalDuration = 0;
                for (var i = 0; i < eventSource.length; i++) {
                    var event = eventSource[i]
                    var block = {};
                    block.start = event.start.getHours() + event.start.getMinutes()/60;
                    block.end = event.end.getHours() + event.end.getMinutes()/60;
                    totalDuration += block.end - block.start;
                    timeBlocks.push(block);
                }
				
				for (var i = 0; i < travelTimeEventSource.length; i++) {	
                    var event = travelTimeEventSource[i]
                    var block = {};
                    block.start = event.start.getHours() + event.start.getMinutes()/60;
                    block.end = event.end.getHours() + event.end.getMinutes()/60;
                    totalDuration += block.end - block.start;
                    timeBlocks.push(block);
                }
            
                var problem = "Two of the items in the itinerary are overlapping.  Move them around so that no activities cover each other, or remove activities to free up time.";
                var n = new note("Itinerary items are overlapping",
                problem, ['todo', 'time']);
                var si = new streamitem('todo', n, null);
                si.id = 'sys_overlap_items';
                
                var add = false;
                for (var j in timeBlocks) {
                    var check = timeBlocks[j];
                    for (var k in timeBlocks) {
                        var other = timeBlocks[k];
						if (check.end*60 < calBegin || other.end*60 < calBegin) {
							continue;
						}
                        if ((check.start < other.end && check.start > other.start) || (check.end > other.start && check.end < other.end)) {
                            add = true;
                        }
                    }
                }
                
                if (add && $("#stream_sys_overlap_items").length == 0) {
                    sysStream.push(si);
                    
                    if (inProgress) {
                        displayStreamItem("#replanStreamBody", si);
                    } else {
                        displayStreamItem("#sysStreamBody", si);
                    }
                }
            }
            
            // Shifts event times by specified value
            function shiftEventTimes() {
                var times = $(".fc-event-time");
                for (var t = 0; t < times.size(); t++) {
                    var oldTimes = $(times[t]).parent().html();
                    var newTimes = oldTimes;
                    if (newTimes) {
                        for (var i = 1; i < 13; i++) {
                            var up = i+shift;
                            if (up > 12) {
                                up = up - 12;
                            }
                            newTimes = newTimes.replace(">" + i + ":", "> " + up + ":");
                            newTimes = newTimes.replace(">" + i + ":", "> " + up + ":");
                            newTimes = newTimes.replace("- " + i + ":", " -  " + up + ":");
                            newTimes = newTimes.replace("- " + i + ":", " -  " + up + ":");
                            
                        }               
                        $(times[t]).parent().html(newTimes);
                    }
                }
				
				$(".fc-event").css("font-size", "1em");
				$(".fc-event").css("font-weight", "bold");
            }
     			
			// Updates the pin numbers on the calendar
			function updateCalendarPins() {
				$(".deleteme").remove();
				var eventDivs = $(".fc-event-title");
				for (var i = 0; i < itinerary.length; i++) {
					for (var j = 0; j < eventDivs.length; j++) {
						if (getItem(itinerary[i]).value == $(eventDivs[j]).html()) {
							$(eventDivs[j]).parent().prepend("<div class='sspinpos deleteme' style='float:left; margin-right:10px; margin-top:2px'>"+(i+1)+"</div>");
						}
					}
				}
			}
			
			// Change color of event headers
			function colorHeaders() {
				//if (!inProgress) {
				//	$(".fc-event-head").css("background-color","#CCCCCC");
				//} else {
					var eventDivs = $(".fc-event-title");
					for (var i = 0; i < itinerary.length; i++) {
						for (var j = 0; j < eventDivs.length; j++) {
							if ($(eventDivs[j]).html() == "Travel Time" || $($(eventDivs[j]).parent().parent().children()[0]).html().indexOf("Travel Time") != -1) {
								continue;
							}
							if (getItem(itinerary[i]).data.start >= calBegin && getItem(itinerary[i]).value == $(eventDivs[j]).html()) {
								$($(eventDivs[j]).parent().parent().children()[0]).css("background-color", "#CCCCCC");
							}
						}
					}
				//}
			}
	 
            // Save dragged and drop edit
            function saveItemEdit(oldsi) {
				if(!enableEditting){
					revertFunc();
					alert("You must accept the HIT before you can save any edits.");
					return;
				}
			
                var oldid = oldsi.id;
                newactpinMoved = false;
                var n = new activity(oldsi.data.name, oldsi.data.description, null, oldsi.data.location, null, oldsi.data.duration, oldsi.data.categories);

                var si = new streamitem('activity', n, null);
                si.data.start = oldsi.data.start;

                if (oldsi.edited == undefined) {
                    si.edited = [uid];
                } else {
                    si.edited = oldsi.edited;
                    si.edited.push(uid);
                }

                // submit it
                var id = submitEdit(si, oldid);
                if (id != null) {
                    si.id = 'user_' + id;
                } else {
                    return;
                }
                
                // add it to local stream
                userStream.unshift(si);
                searchAutocomplete.autocomplete("option", "source", userStream);
                newStream.unshift(si);

                // 3. what about itinerary?
                // 3a... in itinerary list, get rid of old and insert new
                var initinerary = false;
                var pos = 1;
                for (var i = 0; i < itinerary.length; i++) {
                    if (itinerary[i] == oldid) {
                        pos = i + 1;
                        itinerary.splice(i, 1, si.id);
                        initinerary = true;
                        break;
                    }
                }

                var item = createStreamItem(si);
                $('#userStreamBody').prepend(item);

                // remove the old one
                // 1. remove from stream
                $('#stream_' + oldid).remove();
                // 2. remove from userStream

                for (var i = 0; i < userStream.length; i++) {
                    if (userStream[i].id == oldsi.id) {
                        userStream.splice(i, 1);
                        break;
                    }
                }

                if (initinerary) {
                    // HQ: NOTE: WE DO NOT SAVE THE ITINERARY. We just update things so that 
                    // if the person were to save then it would save correctly. Instead of saving the 
                    // itinerary, we update the change onto the latest state in the system in SubmitEdit

                    // save the itinerary before moving on.
                    //saveItinerary();

                    // 3b... in wayhash, get rid of old and insert new;
                    waylayer.DeleteShape(wayhash[oldid].pin);
                    delete wayhash[oldid];
                    AddWaypointPin(si);


                    // 3c... in itinerary display, get rid of old and insert new

                    var item = createItineraryItem(si.id, true, pos, si.data.name, si.data.location.name, '' + si.data.duration + ' min + travel', true);
                    $(item).insertAfter('#' + oldsi.id);
                    $('#' + oldsi.id).remove();
                    updateItineraryDisplay();
                
                    updateEditCalendar(oldid, si.id); // for calendar
                }
            }
          
			// Click handler for events in the calendar
			function eventClick(calEvent, jsEvent, view) {
				var item = getItem(calEvent.itId);
                map.SetCenter(new VELatLong(item.data.location.lat, item.data.location.long));
				map.SetCenter(new VELatLong(item.data.location.lat, item.data.location.long));
				var index = itinerary.indexOf(calEvent.itId) + 1;
				var pins = $(".pinpos");
				for (var i = 0; i < pins.length; i++) {
					if ($(pins[i]).text() == index) {
						$(pins[i]).mouseover();
					}
				}
			}
		  
			///////////////////////////////////////////
            // TRAVEL TIME CODE
            ///////////////////////////////////////////
			
			// Do NOT change this reference
			var travelTimeEventSource = [];
			
			// Draw travel times after new route calculation
			function drawTravelTimes(legTimes) {
				travelTimeEventSource.length = 0;
				var roundedTimes = []
				for (var i = 0; i < legTimes.length; i++) {
					roundedTimes.push(Math.round(legTimes[i] / 60));
				}
				
				for (var i = 0; i < roundedTimes.length; i++) {
					if (roundedTimes[i]%15 < 7) {
						roundedTimes[i] = Math.floor(roundedTimes[i] / 15) * 15;
					} else {
						roundedTimes[i] = Math.ceil(roundedTimes[i] / 15) * 15;
					}
				}
				
				for (var i = 0; i < itinerary.length; i++) {
					if (roundedTimes[i] == 0) {
						continue;
					}
					var event = {};
					var item = getItem(itinerary[i]);
					event.title = "Travel Time";
					
					event.end = new Date(y, m, d, Math.floor(item.data.start/60) - shift, item.data.start%60);
					event.start = new Date(y, m, d, Math.floor((item.data.start-roundedTimes[i])/60) - shift, (item.data.start-roundedTimes[i])%60);
					
					event.itId = itinerary[i];
					event.isTravel = true;
					event.editable = false;
					
					if (item.data.start >= calBegin) {
						event.color = "rgb(3, 209, 92)";
					} else {
						event.color = "grey";
					}
					
					travelTimeEventSource.push(event);
				}
				
				console.log(travelTimeEventSource);
				
                $("#calendar").fullCalendar('refetchEvents');
				
				console.log(travelTimeEventSource);
				
				shiftEventTimes();
				colorHeaders();
				updateCalendarPins();
				
				detectOverlap();
			}
			
			// Removes the travel times from the calendar
			function clearTravelTimes() {
				travelTimeEventSource.length = 0;
				$("#calendar").fullCalendar('refetchEvents');
			}
		  
            ///////////////////////////////////////////
            // CHECK ITEM CODE
            ///////////////////////////////////////////
            
            // Creates a check item from a stream item object
            function createCheckItem(id, si) {
                var item = $(document.createElement('tr'));
                item.addClass(si.type);

                var msg = $(document.createElement('td'));
                msg.css('width', '100%');
                msg.append('<b>' + si.data.name + '</b>');
                msg.append('<br/>');
                
                //var desc = takeTill(si.data.description, 150);
                var desc = si.data.description.split('<ul')[0];
				var descntag = $(document.createElement('div'));
                descntag.addClass('sidesc');
                descntag.append(desc);
                descntag.append('<br/>');

                for (var i = 0; i < si.data.categories.length; i++) {
                    descntag.append("<span style='float:left;white-space:no-wrap;'><a class='tagstreamitem' href='#' onclick=" + "\"filterOnTag('" + si.data.categories[i] + "')\">" + '#' + si.data.categories[i] + "</a></span>");
                }

                msg.append(descntag);

                var time = $(document.createElement('td'));
                time.css('width', '0%');
                time.attr('id', 'stime_' + si.id);
                var tt = $(document.createElement('div'));
                tt.addClass('badge_' + si.type);
				tt.text("!!");
                time.append(tt);
                item.append(msg);
                item.append(time);

                $(item).click(function () {
                    viewCheck(si);
                });
                
                $(item).attr('id', 'stream_' + si.id);
                $(id).prepend(item);
                
                //checkItems[si.id] = si;
                //saveCheckItems();
            }
            
            // View a checked item in the overlay box
            function viewCheck(si) {
                $('#box').css('left', '30%');
                $('#box').css('right', '30%');

                $('#addActivity').hide();
                $('#addNote').hide();
                $('#viewCheck').show();
                $('#viewActivity').hide();
                $('#viewNote').hide();
				
                $('#viewcheckdesc').html(si.data.description);
				$('#viewchecklist').html(si.requestCheck);
                
                $('#overlay').fadeIn('fast', function () {
                    $('#box').animate({
                        'top': '20px'
                    }, 500);
                });
                
                $("#resolvebutton").unbind("click");
                $("#resolvebutton").click(function() {
                    si.onResolve()
                });
				
				if (isTask) {
					$("#gotit").show();
					$(".resolveSelect").hide();
				} else {
					$("#gotit").hide();
					$(".resolveSelect").show();
				}

				$('#viewchecklist').hide();
				$('#viewcheckdesc').show();
				
				$('.submitCheck').click(function() {
					if( $('.submitCheck').filter(':not(:checked)').length === 0){
						$(".resolveSelect").show();
					} else {
						$(".resolveSelect").hide();
					}
				});
            }
            
            // Save current check item state
            function saveCheckItems() {
                state.checkItems = checkItems;

                var ret = true;

                jQuery.ajax({
                    type: "POST",
                    url: "http://people.csail.mit.edu/jrafidi/Crowdcierge/mobi/submitTurkTourItinerary.php",
                    async: false,
                    data: ({
                        userId: uid,
                        answer: JSON.stringify(state),
                        taskId: tid,
                        startState: stateId,
                        assignmentId: assignmentId,
                        type: "turktour"
                    }),
                    success: function (msg) {
                        if (msg == "") {
                            // cannot save it
                            alert("It appears that someone else has recently made a change that conflicts with the changes you are trying to save. Please refresh the page before continuing. We apologize for the inconvenience");
                            ret = false;
                            return;
                        } else {
                            disableItSave();
                        }
                    }
                });
                return ret;
            }
                        
            ///////////////////////////////////////////
            // LOAD INTERMEDIATE STATE CODE
            ///////////////////////////////////////////
            
            // Boolean to determine if the trip is in progress, either determined by time or set in DB
            var inProgress = false;
            
            // Boolean to determine if we should set the calendar start or make finished activities a diff color
            var setStart = false;
            
            // Local storage of intermediate state data
            var inter;
            var interTime;
            var interLat;
            var interLog;
            var finishedAct = [];
            var fixRequest;
            var keepAct = [];
            var currentPin;
            
            var requestCheckItem;
            
			var requestTitle = 	{
								"replace"       : "Replace Activity <b>{0}</b> in Itinerary",
            
                                "stuck"         : "Add Activities close to Traveler to Itinerary",
                                
                                "delayed"       : "Traveler is delayed",
                                
                                "addMoreLike"   : "Add more Activities like {0} to Itinerary",
                                
                                "addNow"        : "Add something to the Itinerary for the Traveler to do now",
                                
                                "cantGo"        : "Traveler can't get to {0}, add something else to Itinerary",
                                
                                "custom"        : "A Traveler needs your help! Click to read."
                                }
			
            var requestText =   {
                                "replace"       : "A traveler wants something to do instead of <b>{0}</b>. <ul><li><b>First, remove {0} from the itinerary.</b>  This is the activity the traveler doesn't want to do anymore. </li><li><b>Next, add a different activity in its place.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li></ul>",
								
								"stuck"       : "A traveler is stuck and can't get to his next activity, <b>{0}</b>. <ul><li><b>First, remove {0} from the itinerary.</b>  This is the activity the traveler can't get to. </li><li><b>Next, add a different activity in its place.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li></ul>",
                                
								"delayed"       : "A traveler is delayed and can't get to his next activity on time. <ul><li><b>Make his upcoming activities start at least 30 minutes later in the day, either by changing them or removing them.</b></li></ul>",
                                
								"addMoreLike"       : "A traveler wants his plan changed to add more activities like <b>{0}</b>. <ul><li><b>Add activities like {0} to the itinerary.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li><li><b>If needed, move or remove some activities from the itinerary to make space.</b>. </li></ul>",
                                
								"addNow"       : "A traveler wants something to do right now. <ul><li><b>Add an activity near the traveler on the map that starts very soon to the Current Time on the calendar.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li><li><b>If needed, move or remove activities to make room.</b></li></ul>",
                                
								"cantGo"       : "A traveler can't do their next planned activity, <b>{0}</b>. <ul><li><b>First, remove {0} from the itinerary.</b>  This is the activity the traveler says is closed or unavailable.</li><li><b>Next, add a different activity in its place.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li></ul>",
								
								"custom"       : "A traveler needs your help to fix his trip plan.  Follow his instructions below: <ul><li><b> {2} </b></li></ul>",
                                }
			
			var requestCheck = 	{
								"replace"       : "A traveler wants something to do instead of <b>{0}</b>.  Once you've completed all the micro-tasks, you'll be able to submit.  <br/> <br/> <input type='checkbox' class='submitCheck'> I have removed the activity <b>{0}</b>. </input> <br/> <br/> <input type='checkbox' class='submitCheck'> I have added a new activity in its place, taking into account that the traveler likes these things: {1}. </input><br/> <br/> <input type='checkbox' class='submitCheck'> I have placed the activity at a proper time and location based on where the traveler is right now. </input><br/> <br/> <input type='checkbox' class='submitCheck'> I made a reasonable effort to help this traveler. </input><br/> <br/> ",
								
								"stuck"       : "A traveler is stuck and can't get to his next activity, <b>{0}</b>. <ul><li><b>First, remove {0} from the itinerary.</b>  This is the activity the traveler can't get to. </li><li><b>Next, add a different activity in its place.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li></ul>",
                                
								"delayed"       : "A traveler is delayed and can't get to his next activity on time. <ul><li><b>Make his upcoming activities start at least 30 minutes later in the day, either by changing them or removing them.</b></li></ul>",
                                
								"addMoreLike"       : "A traveler wants his plan changed to add more activities like <b>{0}</b>. <ul><li><b>Add activities like {0} to the itinerary.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li><li><b>If needed, move or remove some activities from the itinerary to make space.</b>. </li></ul>",
                                
								"addNow"       : "A traveler wants something to do right now. <ul><li><b>Add an activity near the traveler on the map that starts very soon to the Current Time on the calendar.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li><li><b>If needed, move or remove activities to make room.</b></li></ul>",
                                
								"cantGo"       : "A traveler can't do their next planned activity, <b>{0}</b>. <ul><li><b>First, remove {0} from the itinerary.</b>  This is the activity the traveler says is closed or unavailable.</li><li><b>Next, add a different activity in its place.</b> You can suggest a new activity to add or add an existing activity suggestion from the Brainstream.</li></ul>",
								
								"custom"       : "A traveler needs your help to fix his trip plan.  Follow his instructions below: <ul><li><b> {2} </b></li></ul>",
								}
            
			var keepInMind = "Keep the following in mind while you do the task:<ul><li><b>The traveler is located at the orange pin <img style='vertical-align:text-bottom' src='pin-user-2.png'/> on the map, and the <span style='background-color: rgba(255, 165, 0, 0.6)'>Current Time</span> is marked on the calendar.</b></li><li><b>He likes the following things: {0}.  Click \"reveal mission details\" at the top to learn more.</b>  The mission details explain what the traveler originally wanted on their trip. </li><li> Any reasonable effort to resolve the conflict will result in payment for this task.  </ul>"
			
            var submissionInstructions = 'When you are finished, click the Submit button to see this again and confirm you solved the problem.';
            var oldItinerary;
            
			var startTaskTime = (new Date()).getTime();
			
            // Load intermediate state
            function loadIntermediateState() {
                // Show the replanning stream, not the full sys stream
                $("#sysStreamBody").hide();
                $("#replanStreamBody").show();
            
                inter = state.inter
                interTime = inter.time;  // Time of request
                interLat = inter.lat;   // Latitude location
                interLong = inter.long; // Longitude location
                keepAct = inter.keepActivities;    // What activities need to remain on the itinerary (optional)
                fixRequest = inter.request;    // What the request is, containing extra info if needed
                oldItinerary = JSON.stringify(itinerary);
                
                // Set calendar check time to intermediate time
                calBegin = interTime;
                
                // Place user pin at current location and center map on that location
                var locLL = new VELatLong(interLat, interLong);
                currentPin = AddPushpin(map, locLL, "Traveler's Location", "Where the traveler is right now", false, "pin-user-2.png");
				$("img[src$='pin-user-2.png']").parent().parent().css("z-index", 10000);
                map.SetCenter(locLL);
				
				AddPushpin(newactmap, locLL, "Traveler's Location", "Where the traveler is right now", false, "pin-user-2.png");
				
				$("html").mouseover(function() {
					$("img[src$='pin-user-2.png']").parent().parent().css("z-index", 10000);
				});
				$("#mapDiv").mouseup(function() {
					$("img[src$='pin-user-2.png']").parent().parent().css("z-index", 10000);
				});
            }
            
            // Create the check item related to the request
            function processRequest() {
                var problem;
				var title;
                if (fixRequest.data.activity.id) {
					var pinString = "<span><span class='sspinpos' style='display:inline-block'>" + (fixRequest.data.activity.position+1) + "</span><span style='font-style:italic; font-weight:bold'>" + fixRequest.data.activity.name + '</span></span>';
                    problem = jQuery.validator.format(requestText[fixRequest.type], pinString, fixRequest.data.activity.position, fixRequest.data.message, categories.join(", "));
					title = jQuery.validator.format(requestTitle[fixRequest.type], pinString, fixRequest.data.activity.position, fixRequest.data.message, categories.join(", "));
                } else {
					title = jQuery.validator.format(requestTitle[fixRequest.type], "", "", fixRequest.data.message);
                    problem = jQuery.validator.format(requestText[fixRequest.type], "", "", fixRequest.data.message);
                }
                problem = problem + jQuery.validator.format(keepInMind, categories.join(", ")) + submissionInstructions;
                var checklist = jQuery.validator.format(requestCheck[fixRequest.type], pinString, categories.join(", "));
				
                var n = new note(title, problem, ['check', 'request']);
                var si = new streamitem('check', n, null);
				si.requestType = fixRequest.type;
				si.requestCheck = checklist;
                si.id = 'sys_request_check';
                si.onResolve = function() {
					if (!enableEditting) {
						alert("You need to accept the HIT and fix the problem before you can submit.");
						return;
					}
					
                    if ($("#stream_sys_overlap_items").length != 0) {
                        alert("Some items in the plan are overlapping.  You can only submit the task when no two events are scheduled during the same time.");
                        return;
                    }
                    
                    if (oldItinerary == JSON.stringify(itinerary)) {
                        alert("You didn't make any changes to the trip plan, so you can't submit this task yet.  Fix the trip plan and then submit.");
                        return;
                    }
                    
                    $("#stream_" + si.id).remove();
                    delete checkItems[si.id];
                    saveResolution();
                    closeAdd();
					
					if (isTask) {
						$("#submitter").click();
					} else {
						alert("Hurray, you finished!  Thanks for helping me debug this.  Please don't change anything else about the plan now.");
					}
                };
                
                requestCheckItem = si;
                createCheckItem("#checkStreamBody", si);
            }
            
            // Save that the intermediate problem has been resolved
            // Currently just sets inProgress to false
            function saveResolution() {
                state.inProgress = false;
				var d = new Date();
				state.inter.taskCompleteTime = d.getTime() - startTaskTime;
                
                var ret = true;

                jQuery.ajax({
                    type: "POST",
                    url: "http://people.csail.mit.edu/jrafidi/Crowdcierge/mobi/submitTurkTourItinerary.php",
                    async: false,
                    data: ({
                        userId: uid,
                        answer: JSON.stringify(state),
                        taskId: tid,
                        startState: stateId,
                        assignmentId: assignmentId,
                        type: "turktour"
                    }),
                    success: function (msg) {
                        if (msg == "") {
                            // cannot save it
                            alert("It appears that someone else has recently made a change that conflicts with the changes you are trying to save. Please refresh the page before continuing. We apologize for the inconvenience");
                            ret = false;
                            return;
                        } else {
                            disableItSave();
                        }
                    }
                });
                return ret;
            }
                        
            ///////////////////////////////////////////
            // EXPLANATION BOX CODE
            ///////////////////////////////////////////
            
            var showExplanation = true;
            
            // Show either the mission or the check item for the replanning task
            function showExplanationBox() {
                if (!showExplanation) {
                    return;
                }
                
                if (inProgress) {
                    viewCheck(requestCheckItem);
					$("#gotit").show();
                    $(".resolveSelect").hide();
                    $("#gotit").click(function() {
                        closeAdd();
                    });
                } else {
                    viewMission();
                }
            }
            
        </script>
        
        <style media="screen" type="text/css">
            #calendar {
                width:350px;
                margin-left:2%;
                margin-right:2%;
            }
            
            #brainstream tr.check {
                background: yellow;
            }
            
            .badge_check {
                background-position:top center;
                background-repeat:no-repeat;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
                color: black;
                width:25px;
                height:26px;
                font-size: 2em;
            }
        </style>
        
        <style media="screen" type="text/css">
            #tabcontainer ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            #tabcontainer li {
                float: left;
                border: 1px solid #bbb;
                border-bottom-width: 0;
                margin: 0;
            }
            #tabcontainer a {
                text-decoration: none;
                display: block;
                background: white;
                padding: 0.24em 1em;
                color: #7F7F7F;
                width: 8em;
                text-align: center;
            }
            .tabactbut {
                background: #ffab07;
                border: 1px outset #ffab07;
                color: white;
                font-size: 90%;
                margin-top: 5px;
                margin-bottom:5px;
            }
            #tabcontainer a:hover {
                background: white;
            }
            #tabcontainer .selected {
                border-color: #7F7F7F
            }
            #tabcontainer .selected a {
                position: relative;
                top: 1px;
                background: white;
                color: black;
            }
            #content {
                border: 1px solid #7F7F7F;
                clear: both;
                padding: 10px;
            }
            html {
                height:100%;
                max-height:100%;
                padding:0;
                margin:0;
                border:0;
                background:#fff;
                font-size:76%;
                font-family:georgia, palatino linotype, times new roman, serif;
                /* hide overflow:hidden from IE5/Mac */
                /* \*/
                overflow: hidden;
                /* */
            }
            body {
                height:100%;
                max-height:100%;
                overflow:hidden;
                padding:0;
                margin:0px;
                border:0;
                font: 14px Lucida Grande, Arial, sans-serif;
                background-color:white;
            }
            /* background-color:#fbf7d4;}*/
            #header {
                position:absolute;
                margin:0;
                top:0;
                left:0;
                display:block;
                width:100%;
                overflow:auto;
                height:52px;
                background-color:#ffab07;
                font-size:4em;
                z-index:5;
                color:#fff;
            }
            #footer {
                position:absolute;
                margin:0;
                bottom:0;
                left:0;
                display:block;
                width:100%;
                height:35px;
                background:#d3f1f2;
                font-size:0.8em;
                z-index:3;
                text-align:center;
                color:rgb(157, 78, 84);
            }
            #left1 {
                position:absolute;
                left:0;
                top:52px;
                bottom:35px;
                width:30%;
                font-size:1em;
                z-index:4;
                overflow:hidden;
            }
            #left2 {
                position:absolute;
                left:0;
                top:52px;
                bottom:35px;
                width:40%;
                font-size:1em;
                z-index:4;
                overflow:hidden;
            }
            #left3 {
                position:absolute;
                left:0;
                top:52px;
                bottom:35px;
                width:30%;
                font-size:1em;
                z-index:4;
                overflow:hidden;
            }
            * html #left1 {
                height:100%;
                top:0;
                bottom:0;
            }
            /*border-top:100px solid #fff; border-bottom:0px solid #fff;}*/
            * html #left2, * html #left3 {
                height:100%;
                top:0;
                bottom:0;
            }
            /* border-top:100px solid #fff; border-bottom:30px solid #fff;}*/
            #left1 {
                left:0;
                background:#d3f1f2;
            }
            #left2 {
                left:30%;
                background:#ffffff;
            }
            #left3 {
                left:70%;
                background:#ffffff;
            }
            .inner {
                display:block;
                padding:0 10px 10px 10px;
            }
            .bold {
                font-size:1.5em;
                font-weight:bold;
            }
            .headname {
                vertical-align:baseline;
                font-size:260%;
                text-transform: lowercase;
                font-family: Arial, times, Times New Roman, times-roman, georgia, serif;
                /*    font-size: 40px;  */
                line-height: 40px;
                letter-spacing: -1px;
                color: white;
                font-weight: 100;
            }
            a:link {
                color: #0000CE;
                text-decoration: underline;
            }
            a:active {
                color: #0000CE;
                text-decoration: uonderline;
            }
            a:visited {
                color: #0000CE;
                text-decoration: underline;
            }
            a:hover {
                color: #0000CE;
                text-decoration: underline;
            }
            a.tagrowitem {
                margin-right:10px;
                color: #0000CE;
                text-decoration: none;
                float:left;
            }
            a.tagstreamitem {
                margin-right:10px;
                color: #0000CE;
                text-decoration: none;
                float:left;
            }
            a.tagstreamitem:hover {
                text-decoration: underline;
            }
            a.tagrowitem:hover {
                text-decoration: underline;
            }
            .ui-icon {
                list-style: none outside none;
                margin: 0px;
                width: 10px;
            }
            .missionbuttons {
                vertical-align:baseline;
                font-size:150%;
                border:1px outset black;
                padding:3px;
                background-color:#0000CE;
                color:white;
            }
            #addbutton {
                border: 1px outset black;
                background:#ffab07;
                color: white;
                font-size: 75%;
            }
            #snapshotbutton {
                border: 1px outset black;
                background:#ffab07;
                color: white;
                font-size: 70%;
            }
            #streamsearch {
                padding-top:10px;
                margin-top:10px;
                padding-bottom:2px;
            }
            .innerstream {
                position:relative;
                width:96%;
                margin-left:2%;
                margin-right:2%;
                display:block;
            }
            .inneritinerary {
                position:relative;
                width:96%;
                margin-left:2%;
                margin-right:2%;
                display:block;
            }
            #brainstream {
                border-collapse: collapse;
                position:relative;
                width:96%;
                overflow: auto;
                margin-left:2%;
                margin-right:2%;
                display:block;
                height:80%;
            }
            #itinerary tr {
                background: white;
            }
            #sortable {
                padding: 0;
                border-collapse: collapse;
                position:relative;
                width: 96%;
                overflow:auto;
                margin-left:2%;
                margin-right:2%;
                display:block;
                height:87%;
                list-style-type: none;
                margin-bottom: 0;
                padding: 0;
            }
            #sortable td {
                vertical-align: top;
                padding-bottom:3px;
                padding-top:3px;
                /* border-spacing: 5px; */
            }
            #sortable td.endpos {
                padding-right:12px;
            }
            #sortable td.itpos {
                padding-right:12px;
                text-align:center;
            }
            #sortable td.ittime, .endtime {
                color: gray;
            }
            .pinpos {
                background: url('wp.gif');
                background-position:top center;
                background-repeat:no-repeat;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
                color: #fff;
                width:25px;
                height:26px;
                font-size: 82%;
            }
            .badge_todo {
                background: url('exclamation-icon.png');
                background-position:top center;
                background-repeat:no-repeat;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
                color: #fff;
                width:25px;
                height:26px;
                font-size: 85%;
            }
            .sspinpos {
                background: url('wp.gif');
                background-position:top center;
                background-repeat:no-repeat;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
                color: #fff;
                width:25px;
                height:26px;
                font-size: 85%;
            }
            #sortable .itposinner {
                background: url('wp.gif');
                background-position:top center;
                background-repeat:no-repeat;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
                color: #fff;
                width:25px;
                height:26px;
            }
            #sortable .startposinner {
                background: url('pin-start-it.png');
                background-position:top center;
                background-repeat:no-repeat;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
                color: #fff;
                width:25px;
                height:26px;
            }
            #sortable .endposinner {
                background: url('pin-end-it.png');
                background-position:top center;
                background-repeat:no-repeat;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
                color: #fff;
                width:25px;
                height:26px;
            }
            #sortable td.itremove {
                padding-left:5px;
            }
            #itinerary td.itremove:hover {
                background: white;
            }
            #brainstream td {
                padding-left:6px;
                padding-right:6px;
            }
            #brainstream tr {
                border-bottom: 1px solid gray;
                vertical-align: top;
                background: #ffffff;
            }
            #brainstream tr.todo {
                background: #fbf7d4;
            }
            #brainstream .sidesc {
                padding-left:12px;
            }
            #viewNoteTable td {
                vertical-align: baseline;
            }
            #viewActivityTable td {
                vertical-align: baseline;
            }
            #viewActivityTable td.vlabel {
                width:120px;
            }
            #braintitle {
                color: #0000CE;
                padding-bottom:0px;
            }
            .sectiontitle {
                font-size:135%;
                color: #ffab07;
                font-weight:bold;
                padding-top: 10px;
                padding-bottom:16px;
            }
            .sectioninstruction {
                color:#ffab07;
                font-size:76%;
                display:none;
            }
            #showall {
                /*   text-align:right; */
            }
            #brainstream tr.todo:hover {
                background-color: #eae6c3;
            }
            #brainstream tr:hover {
                background-color: #e9e9e9;
            }
            #searchBox.ui-autocomplete-input {
                z-index: 20;
            }
            .ui-autocomplete {
                max-height: 100px;
                overflow-y: auto;
                /* prevent horizontal scrollbar */
                overflow-x: hidden;
                /* add padding to account for vertical scrollbar */
                padding-right: 20px;
            }
            /* Style for overlay and box */
            .overlay {
                background:transparent url(images/overlay.png) repeat top left;
                position:fixed;
                top:0px;
                bottom:0px;
                left:0px;
                right:0px;
                z-index:100;
            }
            .box {
                position:fixed;
                padding:20px;
                top:-700px;
                left:30%;
                right:30%;
                background-color:#fff;
                color:#7F7F7F;
                border:2px solid #ccc;
                -moz-border-radius: 20px;
                -webkit-border-radius:20px;
                -khtml-border-radius:20px;
                -moz-box-shadow: 0 1px 5px #333;
                -webkit-box-shadow: 0 1px 5px #333;
                z-index:101;
            }
            .box h1 {
                border-bottom: 1px dashed #7F7F7F;
                margin:-20px -20px 0px -20px;
                padding: 15px 10px 10px 10px;
                background-color:#FFEFEF;
                color:#EF7777;
                -moz-border-radius:20px 20px 0px 0px;
                -webkit-border-top-left-radius: 20px;
                -webkit-border-top-right-radius: 20px;
                -khtml-border-top-left-radius: 20px;
                -khtml-border-top-right-radius: 20px;
            }
            a.boxclose {
                float:right;
                width:26px;
                height:26px;
                background:transparent url(images/cancel.png) repeat top left;
                margin-top:-30px;
                margin-right:-30px;
                cursor:pointer;
            }
            .addactheader {
                white-space:no-wrap;
            }
            .addbig {
                border: 1px outset black;
                background:#ffab07;
                color: white;
                font-size: 100%;
                text-align:center;
            }
            .signupit {
                border: 1px outset black;
                background:#ffab07;
                color: white;
                font-size: 100%;
                text-align:center;
            }
            .addit {
                border: 1px outset black;
                background:#ffab07;
                color: white;
                font-size: 50%;
                text-align:center;
            }
            .addwide {
                border: 1px outset black;
                background:#ffab07;
                color: white;
                font-size: 50%;
                text-align:center;
                padding:4px;
            }
            div.row {
                clear: both;
                padding-top: 5px;
            }
            div.row span.label {
                float: left;
                width: 20%;
                text-align: right;
            }
            div.spacer {
                clear: both;
            }
            div.row span.formw {
                width: 70%;
                text-align: left;
                float: right;
            }
            /* --> */
        </style>
    </head>
    
    <body>
        <div class="header" style ='white-space:nowrap;vertical-align:baseline;padding-top:10px;padding-left:10px;background:#FFAB07;color:white;'>
            <div> <span class='headname' id='eventName'></span>
                <span style='margin-left:10px'>
                  <button class='missionbuttons'  onclick="viewMission()">reveal mission details</button>
                </span>
                <span style='margin-left:10px'>
                    <!--      <button class='missionbuttons'  onclick="viewHelp()">what you can do to help</button>-->
                    <button class='missionbuttons'  onclick="viewHelp()" id="helpButton" >What you can do</button>
                </span>
                <span style='margin-left:10px'>
                    <a target='_blank' href="http://people.csail.mit.edu/jrafidi/Crowdcierge/mobi/Mobi/Mobi_Turk_Tutorial.html">confused? check out the tutorial</a>
                </span>
            </div>
        </div>
        <!--<div class="header" style='padding-left:12px;padding-bottom:12px;background:#fbf7d4'
        id='tagrow'></div>-->
        <!-- The overlay and the box -->
        <div class="overlay" id="overlay" style="display:none;"></div>
        <div class="box" id="box">
            <a class="boxclose" id="boxclose"></a>
            <div id='signup' style='display:none'>
                <h1 id='signupheader'>Welcome to Mobi!<span style='float:right;'></span></h1>

                <div>
                    <br/>Thanks for coming to help me plan a day of my trip<span id="thanksloc"></span>!
                    Let me know who you are so I can thank you later (and see which suggestions
                    are from you):
                    <br/>
                    <br/>
                    <div class="row"><span class="label">Your name:</span><span class="formw"><input id='signupName' type='text' size='40'/></span>
                    </div>
                    <div class="row"><span class="label">Your email:</span><span class="formw"><input id='signupEmail' type='text' size='40'/></span>
                    </div>
                    <br/>
                    <br/>
                    <div class="spacer"></div>Note: I am participating in a Harvard University research study
                    so the data you enter here may be seen by researchers. Just thought you
                    should know that.
                    <br/>
                    <br/>
                    <div class="row"><span class="label"></span>
                        <span class="formw">
                            <button class='signupit' onClick='signmeup()'>Let me help!</button>
                        </span>
                    </div>
                </div>
            </div>
            <div id='viewMission' style='display:none'>
                 <h1 id='missionheader'>Mission<span style='float:right;'><button onclick="editMission()" id='editmissionbutton' class='addit'>edit mission</button></span></h1>

                <div>
                    <br/>
                    <div id='description'></div>
                    <br/>
                    <div>In planning the event, please pay attention to the wishes below:
                        <br/>	<span id='missionwishes'></span>

                    </div>
                </div>
            </div>
            <div id='viewHelp' style='display:none'>
                 <h1 id='helpheader'>What you can do</h1>

                <div id='helpinstructions'>Others are helping to plan this trip for you. In the meanwhile, you can:
                    <ul>
                        <li><b>Recruit your friends</b>
                            <br/>The more friends you recruit, and the more of them that know about the
                            city you are visiting, the better! You can recruit your friends via email,
                            on Facebook, etc. You should have the link to send them in your email!</li>
                        <li><b>Edit mission details</b>
                            <br/>As people give you suggestions and start to put together the itinerary,
                            it may so happen that you want to make a change to the details you'd filled
                            in at sign up. You can make changes by clicking the 'reveal mission details'
                            button at the top and then edit the mission from there. For start and end
                            locations and times, just click on them in the itinerary to bring up the
                            edit screen.
                            <br/>
                        </li>
                        <!-- <li><b>Locking down activities</b><br/>See something in the itinerary that you absolutely want to keep there? Click the lock button next to the itinerary item to lock it down! If you change your mind, just unlock it and that will allow the folks planning for you to remove it from the itinerary if they wished to do so.</li>-->
                        <li><b>Participate yourself!</b>
                            <br/>If you so wish, you can add ideas to the brainstream and/or itinerary
                            yourself! It's your itinerary... make whatever edits you wish.
                            <br/>
                        </li>
                    </ul>
                </div>
            </div>
            <div id='viewSelect' style='display:none'>
                 <h1 id='selectheader'>Is your idea...</h1>

                <div style='font-size:120%;padding-top:12px;'>
                    <button class='addbig' onclick="$('#viewSelect').hide();addActivity();">something to do or see</button>&nbsp;or
                    <button class='addbig' onclick="$('#viewSelect').hide(); addNote();">a thought about the plan</button>&nbsp;?</div>
            </div>
            <div id='viewNote' style='display:none'>
                <h1 id='viewheader'>Note
                    <span style='float:right;'>
                        <button id='editnotebutton' class='addit'>edit note</button>
                    </span>
                </h1>
                <div>
                    <table id='viewNoteTable'>
                        <tr>
                            <td>Title:</td>
                            <td id='viewtitle'></td>
                        </tr>
                        <tr>
                            <td>Message:</td>
                            <td id='viewdesc'></td>
                        </tr>
                        <tr>
                            <td>Tags:</td>
                            <td id='viewtags'></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id='viewCheck' style='display:none'>
                <h1 id='viewcheckheader'>Your Task: Fix a Trip Plan
                    <span style='float:right;'>
                    </span>
                </h1>
                <div>
                    <table id='viewCheckTable' style="margin-top:10px">
                        <tr>
                            <td></td>
                        </tr>
                        <tr>
                            <td id='viewcheckdesc'></td>
							<td id='viewchecklist'></td>
                        </tr>
                        <tr>
                            <td>
                                <div style='text-align:center; font-size:2.5em'>
                                    <button id='gotit' class='addit'>got it</button>
									<button id='resolvebutton' class='addit resolveSelect'>Submit</button>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id='viewActivity' style='display:none'>
                 <h1 id='viewactheader'>Activity<span style='float:right;'><button id='editacttoitbutton' class='addit'>edit activity</button>&nbsp;<button id='addacttoitbutton' class='addit'>add it to the itinerary</button></span></h1>
                <div id="viewActivityMessage" style="display:none; margin-left:auto; margin-right:auto; font-size:2em; text-align:center">
                    The traveler has already done this activity today.
                </div>
                <div style="float:left; width:40%">
                    <table id='viewActivityTable'>
                        <tr>
                            <td class='vlabel'>Activity:</td>
                            <td id='viewacttitle'></td>
                        </tr>
                        <tr>
                            <td class='vlabel'>Location name:</td>
                            <td id='viewactloc'></td>
                        </tr>
                        <tr>
                            <td class='vlabel'>What to do/see:</td>
                            <td id='viewactdesc'></td>
                        </tr>
                        <tr>
                            <td class='vlabel'>Takes about:</td>
                            <td id='viewactduration'></td>
                        </tr>
                        <tr>
                            <td class='vlabel'>Categories:</td>
                            <td id='viewacttags'></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id='addNote' style='display:none'>
                 <h1 id='addheader'>Add a note<span style='float:right;'><button class='addit' onClick='saveAddNote()'>add note to the stream</button></span></h1>

                <div>
                    <div class="row"><span class="label">Title:</span><span class="formw"><input id='addtitle' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row"><span class="label">Message:</span><span class="formw"><textarea  id='adddesc' type='text' cols='30', rows='6'></textarea></span>
                    </div>
                    <div class="row"><span class="label">Tags:</span><span id='addtags' class="formw">
      </span>
                    </div>
                    <div class="spacer"></div>
                </div>
            </div>
            <div id='editNote' style='display:none'>
                 <h1 id='editheader'>Edit note<span style='float:right;'><button id='saveeditnotebutton' class='addit'>save changes</button></span></h1>

                <div>
                    <div class="row"><span class="label">Title:</span><span class="formw"><input id='edittitle' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row"><span class="label">Message:</span><span class="formw"><textarea  id='editdesc' type='text' cols='30', rows='6'></textarea></span>
                    </div>
                    <div class="row"><span class="label">Tags:</span><span id='edittags' class="formw">
      </span>
                    </div>
                    <div class="spacer"></div>
                </div>
            </div>
            <div id='editMission' style='display:none'>
                 <h1 id='editmissionheader'>Edit mission
      <span style='float:right;'>
	<button id='saveeditmissionbutton' class='addit'>save changes </button>
    </span></h1>

                <div>
                    <div class="row"><span class="label">What you are looking for:</span>
	<span class="formw"><textarea id='editmissiondescription' type='text' style='width:100%' rows='8'></textarea></span>
                        <br/>
                    </div>
                    <div class="row" id='tabcontainer'>
                        <ul>
                            <li class="selected" id="tagtab">
                                <a onclick="showTags()" href="#">Tags</a>
                            </li>
                            <li id="reqtab">
                                <a href="#" onclick="showRequirements()">Requirements</a>
                            </li>
                        </ul>
                    </div>
                    <div id="content">
                        <div id="tagcontent">Existing tags: <span id="editmissionexistingtags"></span>
                            <br/>
                            <button class="tabactbut" onClick="createField('tour_categories', 'categorySet', '', 30)">add a tag</button>
                            <br/>
                            <div id="tour_categories"></div>
                        </div>
                        <div id="requirementcontent">
                            <button class="tabactbut" onClick="createConstraintField('tour_verbal', 'preferenceSet', '', 100, null)">add a requirement</button>
                            <br/>
                            <div class="row" id="tour_verbal"></div>
                            <br/>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
            <div id='editStart' style='display:none'>
                 <h1 id='editstartheader'>Edit starting time and location<span style='float:right;'><button id='saveeditstartbutton' class='addit'>save changes</button></span></h1>

                <div>
                    <div class="row"><span class="label">Location name: </span><span class="formw"><input onblur='editEndsNearby()' id='editstartloc' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row"><span class="label">Start time:</span><span class="formw"><select id='editstarttime'></select></span>
                    </div>
                </div>
                <div class="spacer"></div>
                <div style='color:black'>Drag the location pin
                    <img style='vertical-align:text-bottom' src='pin-end.png'
                    />to its correct location. Suggestions (when available) are shown as
                    <img
                    style='vertical-align:text-bottom' src='pin2.gif' />.</div>
                <div style='height:10px'>&nbsp;</div>
            </div>
            <div id='editEnd' style='display:none'>
                 <h1 id='editendheader'>Edit ending time and location<span style='float:right;'><button id='saveeditendbutton' class='addit'>save changes</button></span></h1>

                <div>
                    <div class="row"><span class="label">Location name: </span><span class="formw"><input onblur='editEndsNearby()' id='editendloc' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row"><span class="label">End time:</span><span class="formw"><select id='editendtime'></select></span>
                    </div>
                </div>
                <div class="spacer"></div>
                <div style='color:black'>Drag the location pin
                    <img style='vertical-align:text-bottom' src='pin-end.png'
                    />to its correct location. Suggestions (when available) are shown as
                    <img
                    style='vertical-align:text-bottom' src='pin2.gif' />.</div>
                <div style='height:10px'>&nbsp;</div>
            </div>
            <div id='editActivity' style='display:none'>
                 <h1 id='editactheader'>Edit activity<span style='float:right;'><button id='saveeditbutton' class='addit'>save changes</button></span></h1>

                <div style="float:left; width:40%">
                    <div class="row"><span class="label">Activity: </span><span class="formw"><input id='editacttitle' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row"><span class="label">Location name: </span><span class="formw"><input onblur='editAutoNearby()' id='editactloc' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row"><span class="label">What to do/see:</span><span class="formw"><textarea id='editactdesc' type='text' style='width:90%' rows='6'></textarea></span>
                    </div>
                    <div class="row"><span class="label">Takes about:</span><span class="formw"><select id='editactduration'></select></span>
                    </div>
                    <div class="row"><span class="label">Category:</span><span id='editacttags' class="formw">
      </span>
                    </div>
                    <!--<div class="spacer"></div>
                    <div style='color:black'>Drag the location pin
                        <img style='vertical-align:text-bottom' src='pin-end.png'
                        />to its correct location. Suggestions (when available) are shown as
                        <img
                        style='vertical-align:text-bottom' src='pin2.gif' />.</div>
                    <div style='height:10px'>&nbsp;</div>-->
                </div>
            </div>
            <div id='addActivity'>
                 <h1 id='addactheader'>Add an activity
      <span id='addcontrols' style='float:right;'><button class='addit' onClick='saveAddActivity(true)'>add it to stream only</button>&nbsp;<button class='addit' onClick='saveAddActivity(false)'>add it to itinerary & stream</button></span></h1>

                <!-- <h1 id='addactheader'>Add an activity<span style='float:right;'><button class='addit' onClick='saveAddActivity(true)'>add it to stream only</button>&nbsp;<button class='addit' onClick='saveAddActivity(false)'>add it to itinerary & stream</button></span></h1> -->
                <div style="float:left; width:40%">
                    <div class="row">
						<span class="label">Activity: </span><span class="formw"><input id='addacttitle' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row">
						<span class="label">Location name: </span><span class="formw"><input onblur='autoNearby()' id='addactloc' type='text' maxlength='60' size='30'/></span>
                    </div>
                    <div class="row">
						<span class="label">What to do/see:</span><span class="formw"><textarea id='addactdesc' type='text' style='width:90%' rows='6'></textarea></span>
                    </div>
                    <div class="row">
						<span class="label">Takes about:</span><span class="formw"><select id='addactduration'></select></span>
                    </div>
                    <div class="row">
						<span class="label">Category:</span><span id='addacttags' class="formw"></span>
                    </div>
                    <div class="spacer">
					</div>
				</div>
				<div id="addmapDiv" style="float:left; width:60%">
                    <div style='color:black' id="pinDirections" >Drag the location pin
                        <img style='vertical-align:text-bottom' src='pin-end.png'
                        />to its correct location. Suggestions (when available) are shown as
                        <img
                        style='vertical-align:text-bottom' src='pin2.gif' />.</div>
                    <div style='height:10px'>&nbsp;</div>
                    <div id='addmapDivMap' style="position:relative;width:100%;height:300px"></div>
                </div>
                <!-- <div style='text-align:center'><button onclick='saveAddActivity(false)'>add activity to itinerary and stream</button><button onclick='saveAddActivity(true)'>add activity to stream only</button><button onclick='closeAdd()'>cancel</button></div>--></div>
        </div>
        <div id="left1">
            <div class='innerstream'>
                <!-- <table id='braintitletable'> -->
                <!-- <tr> -->
                <!-- <td id='braintitle'>Our collective brainstorm</td> -->
                <!-- <td id='showall'><a href='#' onclick='unfilterOnTag()'>view all</a></td> -->
                <!-- </tr> -->
                <!-- </table> -->
                <div id='braintitle' class='sectiontitle'><span style='color:#0000CE'>Our brainstream</span><span class='sectioninstruction'>&nbsp;&nbsp;(click for details)</span>
                </div>
                <div id='showall' style='padding-bottom:10px;display:none'>
                    <a style='color:#0000CE' href='#' onclick='unfilterOnTag()'>view entire stream</a>
                </div>
                <div id='tagrow' style='padding-left:10px;padding-bottom:10px;'></div>
                <div style='display:inline;clear:both;padding:10px;'></div>
                <div id='streamsearch'>
                    <input type="text" id='searchBox' style="color:gray;width:80%" maxlength='60'
                    value='search or add an idea, or click on one below' />&nbsp;
                    <button style='width:16%;' id='addbutton' onclick='addSelect()'>Add</button>
                </div>
            </div>
            <table class='streamclass' id="brainstream">
                <tbody id='checkStreamBody'></tbody>
                <tbody id='replanStreamBody' style="display:none"></tbody>
                <tbody id='sysStreamBody'></tbody>
                <tbody id='userStreamBody'></tbody>
            </table>
        </div>
        <div id="left2">
            <div class="inner">
                <!-- Column two start -->
                <div class='sectiontitle'><span>Map</span><span class='sectioninstruction'>&nbsp;&nbsp;(see the current itinerary)</span>
                </div>
                <div style='padding-bottom:4px; visibility:hidden'>Trip time: <span id='totaltriptime'></span>
                </div>
                <div id='mapDiv' style="z-index:0;position:absolute;width:96%;height:85%"></div>
                <!-- <div id='mapDiv' style="z-index:0;position:relative;width:98%;"></div>       -->
                <div id='stateDisplay'>
                    <!-- Column two end -->
                </div>
            </div>
        </div>
        <div id="left3">
            <div class='inneritinerary'>
                <!-- <div class="inner"> -->
                <div class='sectiontitle' style="padding-bottom:6px"><span>Itinerary</span>&nbsp;&nbsp;&nbsp;
                    <span style='text-align:left'>
                    <!--<button onclick='saveSnapshot()' id='snapshotbutton'>take a snapshot of the itinerary</button>-->
                    <button class='addwide' id='saveitbutton' style='font-size:70%'>save itinerary changes!</button>
                    </span> <br/>
					<span style="width:20px; height:20px; background-color:rgb(3,209,92); font-size: 70%; color: rgb(0, 0, 206); position:absolute; margin-left:100px; margin-top:3px; "></span>
					<span style="margin-top:3px; font-size: 70%; color: rgb(0, 0, 206); position:relative; margin-left: 125px;"> = travel time </span>
					</div>
            </div>
            <table id="finishedTable" style="display:none">
                <tbody id='finishedItinerary'></tbody>
            </table>
            <div style="overflow:auto; height:85%">
                <div id="calendar" ></div>
				<div style="background-color:red; text-align:center; width:300px; margin-left:2%; margin-right:3%; padding-left:12%">End</div>
            </div>
            <table id="sortable" style="display:none">
                <tbody id='itineraryStart'></tbody>
                <tbody id='itinerary'></tbody>
                <tbody id='itineraryEnd'></tbody>
            </table>
        </div>
        <div id="footer">
            <p style='text-align:center'>If you are experiencing problems, please
                <a href="mailto:hq@eecs.harvard.edu">contact us</a>.</p>
        </div>
        
    </body>

</html>