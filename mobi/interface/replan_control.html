<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
</head>
<body style="font-family: helvetica, arial, sans-serif;">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script type="text/javascript">
    
        // Stuff needed to post
        var state;
        var uid = "57187fd22e931d8b2145d920967e559d"; // Test user id
        var stateId;
        var assignmentId = null;
        
        // Test intermediate state
        var testInter = {time:900, lat:36.114708, long:-115.148717, keepActivities:["user_460"]};
        
        // State variables
        var inter = testInter;
        var inProgress = true;
        
        var taskIds =   ["72f2a275c14c3af09e6c2f2b73f03241",
                        "92f792d5f805b79974466450f528d24e",
                        "453ad2e6eeda9e3ccd9d2739c0f1025d",
                        "a31b5015bac8dce3a4e417b5d7fdcb31",
                        "6d33280aa09b19776b7721c98c784223",
                        "083bae9b539973499cf654cd97928b97",
                        "07b00cdb35f7d7b6f78b143435be4233",
                        "08cb0514714ab393ee85f4a81688d3da",
                        "71928f85675acec8da164b317c0acb08",
                        "2507f771e649290105c5180852db4d01",
                        "1ad763711678e776436bd16678d27dc5",
                        "4b4ef627007a24382602411ca491d1e1"]
                        
        var requestTypes = ["replace", "stuck", "delayed", "addMoreLike", "addNow", "custom"];
        
        // Ready form with test data and load state
        $(document).ready(function (jQuery) {            
            for (i=0;i<taskIds.length;i++){ 
                var o = $(document.createElement('option'));
                o.attr('value', taskIds[i]);
                o.text(taskIds[i]);
                $("#taskIds").append(o);
            }
            
            for (i=0;i<requestTypes.length;i++){ 
                var o = $(document.createElement('option'));
                o.attr('value', requestTypes[i]);
                o.text(requestTypes[i]);
                $("#requestTypes").append(o);
            }
            
            tid = taskIds[0];
            loadTaskState();  
            populateForm();
        });
        
        // Populates the custom state form with state data
        function populateForm() {
            $("#tripInfo").html(state.admin.name + " by " + state.admin.creator);
            $("#times").html("(" + state.admin.beginTime + " - " + state.admin.endTime + ")");
            $("#time").val(testInter.time);
            $("#lat").val(testInter.lat);
            $("#long").val(testInter.long);
        
            for (var i=0;i<state.itinerary.length;i++) {
                $("#keepCheck").append("<input type='checkbox' id='myRadio"
                    +state.itinerary[i]+"'/>" + state.itinerary[i] + "<br/>");
            }
            
            for (var i=0;i<state.itinerary.length;i++) {
                $("#requestRadio").append("<input type='radio' name='group1' id='myRadio"
                    +state.itinerary[i]+"'/>" + state.itinerary[i] + "<br/>");
            }
        }
        
        // Load the task state
        // TODO: call again when new task ID is selected
        function loadTaskState() {
            jQuery.ajax({
                type: "GET",
                url: "http://people.csail.mit.edu/hqz/Crowdcierge/mobi/loadTurkTourTaskState.php",
                data: ({
                    type: "turktour",
                    id: tid
                }),
                async: false,
                success: function (obj) {
                    if (obj == "") {} else {
                        state = eval('(' + obj + ')');
                        stateId = state.stateId;
                        state = eval('(' + state.state + ')');
                    }
                }
            });
            return;
        }
        
        // Sets the intermediate state to whatever state was filled in in the form
        function setCustomInter() {
            inProgress = true;
            inter = testInter;
                 
            inter.time = parseInt($("#time").val());
            inter.lat = parseFloat($("#lat").val());
            inter.long = parseFloat($("#long").val());
            
            var keep = [];
            for (var i=0;i<state.itinerary.length;i++) {
                if ($("#myRadio"+state.itinerary[i]).is(":checked")) {
                    keep.push(state.itinerary[i]);
                }
            }
            inter.keepActivities = keep;
            
            var request = {};
            request.type = $('#requestTypes').val();
            request.data = {};
            request.data.activity = $('input:radio[name=group1]:checked').val();
            request.data.message = $("#requestText").val();
            inter.request = request;
            
            console.log(inter);
            
            saveState();
        }
        
        // Save the state
        function saveState() {
            state.inProgress = inProgress;
            state.inter = inter;
                
            var ret = true;

            jQuery.ajax({
                type: "POST",
                url: "http://people.csail.mit.edu/hqz/Crowdcierge/mobi/submitTurkTourItinerary.php",
                async: false,
                data: ({
                    userId: uid,
                    answer: JSON.stringify(state),
                    taskId: tid,
                    startState: stateId,
                    assignmentId: assignmentId,
                    type: "turktour"
                }),
                success: function (msg) {
                    if (msg == "") {
                        // cannot save it
                        alert("It appears that someone else has recently made a change that conflicts with the changes you are trying to save. Please refresh the page before continuing. We apologize for the inconvenience");
                        ret = false;
                        return;
                    }
                }
            });
            return ret;
        }
    
	</script>
	<div style="margin-left:auto; margin-right:auto; float:left; width:200px"> 
        Click the button below to set the task to a custom intermediate state: <br/>
        <button onclick="setCustomInter()"> Set Custom State </button> <br/><br/><br/>
    
        Click the button below to set the task to a test intermediate state: <br/>
        <button onclick="inProgress = true; inter = testInter; saveState()"> Set Test State </button> <br/><br/><br/>
        
        Click the button below to mark the state as no longer in progress: <br/>
        <button onclick="inProgress = false; saveState()"> Clear In Progress </button> <br/><br/><br/>
	</div>

    <div style="float:left; margin-left:50px">
        TID:<select id="taskIds"></select> <br/> 
        <span id="tripInfo"></span> <br/><br/>
        Time: <input type="text" id="time"></input> <span id="times"></span> <br/>
        Lat: <input type="text" id="lat"></input> <br/>
        Long: <input type="text" id="long"></input> <br/>
        Activities to keep: <br/>
        <div id="keepCheck" style="margin-left:20px">
        </div> <br/>
        Request Type :<select id="requestTypes"></select> <br/>
        Relevant Activity (only used for replace and addMoreLike): <br/>
        <div id="requestRadio" style="margin-left:20px">
        </div> <br/> 
        Request Text (only used for custom):<br/>
        <textarea id="requestText"></textarea>
    </div>
    
</body>
</html>